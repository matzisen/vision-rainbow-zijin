import{_ as z,p as J,r as _,D as A,o as F,Y as H,c as f,d as p,e as s,f as n,g as d,h as k,t as C,u,F as P,M as K,T as L,B as Y,w as Z,z as q,A as G,n as $,s as B,Z as Q,$ as X,j as ee,k as I,V as T,a0 as te,a1 as se}from"./index-Drt15aFz.js";const ae={class:"chat-room-page"},oe={class:"nav-header"},ne={class:"nav-content container"},le={class:"user-info"},re={class:"name"},ie={class:"container"},ce={class:"bubble-wrapper"},de={key:0,class:"bubble text-bubble"},ue={class:"img-error"},ve={class:"chat-footer"},pe={class:"container footer-inner"},me={key:0,class:"emoji-popover"},_e={class:"tool-bar"},fe={class:"tool-btn icon-btn",title:"å‘é€å›¾ç‰‡"},be={class:"input-row"},he=["disabled"],W="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",ge={__name:"ChatRoom",setup(ke){const w=J(),l=Number(w.params.id||w.params.targetId),b=JSON.parse(localStorage.getItem("user")||"{}"),v=_(!1),m=_({}),y=_([]),r=_(""),h=_(null);let o=null;const R=A(()=>({Authorization:localStorage.getItem("token")||""})),N=t=>Number(t)===Number(b.id),g=()=>{Q(()=>{h.value&&h.value.scrollTo({top:h.value.scrollHeight,behavior:"smooth"})})},M=t=>{r.value+=t.i},O=async()=>{try{const e=(await B.get(`/api/users/${l}`)).data||{};e.avatar&&!e.avatar.startsWith("http")&&(e.avatar="http://127.0.0.1:8081"+e.avatar,e.avatar=e.avatar.replace("localhost","127.0.0.1")),m.value=e}catch(t){console.error("èŽ·å–å¯¹æ–¹ä¿¡æ¯å¤±è´¥",t),m.value={nickname:`ç”¨æˆ· ${l}`}}},U=async()=>{try{const t=await B.get("/api/chat/messages",{params:{target_id:l}});y.value=t.data||[],g()}catch(t){console.error(t)}},D=()=>{const t=localStorage.getItem("token");if(!t)return;const e=`ws://localhost:8081/api/ws?token=${t}`;o=new WebSocket(e),o.onmessage=i=>{try{const c=JSON.parse(i.data);(Number(c.sender_id)===l&&Number(c.receiver_id)===Number(b.id)||Number(c.sender_id)===Number(b.id)&&Number(c.receiver_id)===l)&&(y.value.push(c),g())}catch{}},o.onopen=()=>console.log("WS å·²è¿žæŽ¥"),o.onclose=()=>console.log("WS æ–­å¼€")},S=()=>{if(!r.value.trim())return;const t={receiver_id:l,content:r.value,type:1};o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify(t)),r.value="",v.value=!1,g()},E=t=>{if(t.url){let e=t.url;e.startsWith("http")||(e="http://127.0.0.1:8081"+e),e=e.replace("localhost","127.0.0.1");const i={receiver_id:l,content:e,type:2};o&&o.readyState===WebSocket.OPEN&&(o.send(JSON.stringify(i)),g())}};return F(async()=>{await O(),await U(),D()}),H(()=>{o&&o.close()}),(t,e)=>{const i=k("el-icon"),c=k("el-avatar"),x=k("el-image"),V=k("el-upload");return p(),f("div",ae,[s("div",oe,[s("div",ne,[s("div",{class:"back-btn",onClick:e[0]||(e[0]=a=>t.$router.go(-1))},[n(i,null,{default:d(()=>[n(u(X))]),_:1})]),s("div",le,[s("span",re,C(m.value.nickname||m.value.username||"ç”¨æˆ· "+u(l)),1),e[5]||(e[5]=s("span",{class:"status-badge"},"åœ¨çº¿",-1))]),e[6]||(e[6]=s("div",{class:"placeholder"},null,-1))])]),s("div",{class:"chat-body",ref_key:"msgBoxRef",ref:h,onClick:e[1]||(e[1]=a=>v.value=!1)},[s("div",ie,[e[7]||(e[7]=s("div",{class:"chat-tip"},"å®‰å…¨æç¤ºï¼šäº¤æ˜“è¿‡ç¨‹ä¸­è¯·å‹¿è½»ä¿¡å¤–éƒ¨é“¾æŽ¥ï¼Œè°¨é˜²è¯ˆéª—",-1)),(p(!0),f(P,null,K(y.value,(a,j)=>(p(),f("div",{key:j,class:$(["message-row animate-slide-in",{self:N(a.sender_id)}])},[n(c,{size:42,src:N(a.sender_id)?u(b).avatar||W:m.value.avatar||W,class:"avatar-img"},null,8,["src"]),s("div",ce,[a.type===1||a.type==="text"?(p(),f("div",de,C(a.content),1)):a.type===2||a.type==="image"?(p(),ee(x,{key:1,src:a.content,class:"bubble image-bubble","preview-src-list":[a.content],fit:"cover","hide-on-click-modal":""},{error:d(()=>[s("div",ue,[n(i,null,{default:d(()=>[n(u(T))]),_:1})])]),_:1},8,["src","preview-src-list"])):I("",!0)])],2))),128))])],512),s("div",ve,[s("div",pe,[n(L,{name:"fade-up"},{default:d(()=>[v.value?(p(),f("div",me,[n(u(te),{native:!0,onSelect:M,class:"custom-picker"})])):I("",!0)]),_:1}),s("div",_e,[s("div",{class:"tool-btn",onClick:e[2]||(e[2]=Y(a=>v.value=!v.value,["stop"])),title:"è¡¨æƒ…"},[...e[8]||(e[8]=[s("span",null,"ðŸ˜€",-1)])]),n(V,{action:"http://127.0.0.1:8081/api/upload",name:"file",headers:R.value,"show-file-list":!1,"on-success":E,class:"upload-wrapper"},{default:d(()=>[s("div",fe,[n(i,null,{default:d(()=>[n(u(T))]),_:1})])]),_:1},8,["headers"])]),s("div",be,[Z(s("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>r.value=a),type:"text",placeholder:"èŠä¸€èŠå®è´ç»†èŠ‚...",onKeyup:G(S,["enter"]),onFocus:e[4]||(e[4]=a=>v.value=!1)},null,544),[[q,r.value]]),s("button",{class:$(["send-btn",{active:r.value.trim()}]),onClick:S,disabled:!r.value.trim()},[n(i,null,{default:d(()=>[n(u(se))]),_:1})],10,he)])])])])}}},we=z(ge,[["__scopeId","data-v-e48ed7cd"]]);export{we as default};
